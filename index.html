<html>
<head>
	<title>Calendar.js</title>
	<link rel="stylesheet" href="css/reset.css"></link>
	<link rel="stylesheet" href="css/colorbrewer.css"></link>
	<link rel="stylesheet" href="css/calendar.css"></link>
</head>
<body>
	<script type="text/javascript" src="js/jquery/jquery-1.8.3.min.js"></script>
	<script type="text/javascript" src="js/d3/d3.min.js"></script>
	<script type="text/javascript" src="js/colorbrewer/colorbrewer.js"></script>

	<script type="text/javascript" src="js/calendar/calendar.js"></script>
	<script type="text/javascript" src="js/calendar/renderer/calendar.renderer.day.js"></script>
	<script type="text/javascript" src="js/calendar/renderer/calendar.renderer.week.js"></script>
	<script type="text/javascript" src="js/calendar/renderer/calendar.renderer.year.js"></script>
	<script type="text/javascript" src="js/calendar/renderer/calendar.renderer.month.js"></script>
	
	

	<script type="text/javascript" src="js/calendar/calendar.data.js"></script>
		<script>
		/* ************************** */
		/* 
			fill displayed select with possible data to displayed
		*/
		function createColorSelector(data, selected, inversed){
			var color = d3.select("#color");
			var color_inversed = d3.select("#color_inversed");
			var inversed = {
				noninversed: "Normal"
				, inversed: "Inverse"
			}
			var select = color.selectAll("option")
				.data(d3.keys(data));

			
			select.enter().append("option")
				.text(function(d){
					return d
				})
				.attr("id", function(d){ 
					return "color_"+d
				})
				.attr("value", function(d){ return d});
			select.exit().remove();
			
			var select_inversed = color_inversed.selectAll("option")
				.data(d3.keys(inversed));
			
			select_inversed.enter().append("option")
				.text(function(d){ return inversed[d]; })
				.attr("id", function(d){ return "color_inversed_"+d })
				.attr("value", function(d){ return d});
			
			select_inversed.exit().remove();
			
			$("#color").css("display", "inline");
			$("#color_inversed").css("display", "inline");
			
			color.select("#color_"+selected).attr("selected", true);	
			if(inversed){
				color_inversed.select("#color_inversed_inversed").attr("selected", true);	
			}
			else{
				color_inversed.select("#color_inversed_noninversed").attr("selected", true);
			}
		}
		/* ************************** */
		/* 
			fill weeks select with week data
		*/
		function createDisplaySelector(data, selected){
			var displays = d3.select("#displays");

			var select = displays.selectAll("option")
				.data(data);

			select.enter().append("option")
				.text(function(d){
					return d;
				})
				.attr("id", function(d){ return "displays_"+d})
				.attr("value", function(d){ return d});
			select.exit().remove();
			
			$("#displays").css("display", "inline");
			
			displays.select("#displays_"+selected).attr("selected", true);	
		}
		/* ************************** */
		/* 
			fill weeks select with week data
		*/
		function createYearSelector(data, selected){
			var years = d3.select("#years");

			var select = years.selectAll("option")
				.data(data);

			select.enter().append("option")
				.text(function(d){
					return d;
				})
				.attr("id", function(d){ return "years_"+d})
				.attr("value", function(d){ return d});
			select.exit().remove();
			
			$("#years").css("display", "inline");
			
			years.select("#years_"+selected).attr("selected", true);	
		}
		/* ************************** */
		/* 
			fill weeks select with week data
		*/
		function createWeekSelector(data, selected){
			var weeks = d3.select("#weeks");
			
			var select = weeks.selectAll("option")
				.data(data);
			
			

			select.enter().append("option")
				.text(function(d){
					return "Semaine " + d;
				})
				.attr("id", function(d){ return "weeks_"+d})
				.attr("value", function(d){ return d});
			select.exit().remove();
			
			$("#weeks").css("display", "inline");
			
			weeks.select("#weeks_"+selected).attr("selected", true);	
		}
		/* ************************** */
		/* 
			fill weeks select with week data
		*/
		function createMonthSelector(selected){
			var year = new Date().getFullYear()
			var data = d3.time.months(
				new Date(year, 0, 1)
				, new Date(year+1, 0, 1)
			);

			var months = d3.select("#months");
			var select = months.selectAll("option")
				.data(data);
			select.enter().append("option")
				.text(d3.time.format("%B"))
				.attr("id", function(d,i){ return "months_"+i})
				.attr("value", function(d,i){ return i});
			select.exit().remove();
			
			$("#months").css("display", "inline");
			
			months.select("#months_"+selected).attr("selected", true);	
		}
		/* ************************** */
		/* 
			fill weeks select with week data
		*/
		function createDaySelector(){
			var monday = d3.time.monday(new Date());
			var sunday = new Date();
			sunday.setTime(monday.getTime() + 7 * 24 * 60 * 60 * 1000);
			var data = d3.time.days(monday,sunday);
			var days = d3.select("#days");
			
			var select = days.selectAll("option")
				.data(data);
			
			select.enter().append("option")
				.text(d3.time.format("%A"))
				.attr("id", function(d,i){ return "days_"+i})
				.attr("value", function(d, i){ return i});
			select.exit().remove();
			
			$("#days").css("display", "inline");
		}
		/* ************************** */
		/* 
			fill weeks select with week data
		*/
		function createThemeSelector(data, selected){
			var themes = d3.select("#themes");
			
			var select = themes.selectAll("option")
				.data(data);
			
			

			select.enter().append("option")
				.text(function(d){
					return d;
				})
				.attr("id", function(d){ return "theme_"+d})
				.attr("value", function(d){ return d});
			select.exit().remove();
			
			$("#themes").css("display", "inline");
			
			themes.select("#theme_"+selected).attr("selected", true);	
		}

		var formatTimeStampUrl = function (time){
				var str = time.getFullYear();
				str += "-";
				str +=time.getMonth() + 1;
				str += "-";
				str += time.getDate();
				return str;
			}
		

		$.ready = function(){


			/* 
				RTE DATA MAPPING
			*/
			
			// var rte_data = json.mixenergies.list;
			var rteCo2Callback = function(d){  return d.tauxDeCo2; };
			var rteConsommationCallback = function(d){ return d.conso; };
			var rteNucleairePercentCallback = function(d){
				var conso = 
				((d.autres) ? d.autres : 0)
				+ ((d.charbon) ? d.charbon : 0)
				// + ((d.echCommAllemagne) ? d.echCommAllemagne : 0)
				// + ((d.echCommAngleterre) ? d.echCommAngleterre : 0)
				// + ((d.echCommBelgique) ? d.echCommBelgique : 0)
				// + ((d.echCommEspagne) ? d.echCommEspagne : 0)
				// + ((d.echCommItalie) ? d.echCommItalie : 0)
				// + ((d.echCommSuisse) ? d.echCommSuisse : 0)
				// + ((d.echPhysiques) ? d.echPhysiques : 0)
				+ ((d.eolien) ? d.eolien : 0)
				+ ((d.fioul) ? d.fioul : 0)
				+ ((d.gaz) ? d.gaz : 0)
				+ ((d.hydraulique) ? d.hydraulique : 0)
				+ ((d.nucleaire) ? d.nucleaire : 0)
				+ ((d.pompage) ? d.pompage : 0)
				+ ((d.solaire) ? d.solaire : 0)

				return (d.nucleaire && conso) ? d.nucleaire * 100 / conso : null; 
			};
			var rteNRJRenPercentCallback = function(d){
				var conso = 
				((d.autres) ? d.autres : 0)
				+ ((d.charbon) ? d.charbon : 0)
				// + ((d.echCommAllemagne) ? d.echCommAllemagne : 0)
				// + ((d.echCommAngleterre) ? d.echCommAngleterre : 0)
				// + ((d.echCommBelgique) ? d.echCommBelgique : 0)
				// + ((d.echCommEspagne) ? d.echCommEspagne : 0)
				// + ((d.echCommItalie) ? d.echCommItalie : 0)
				// + ((d.echCommSuisse) ? d.echCommSuisse : 0)
				// + ((d.echPhysiques) ? d.echPhysiques : 0)
				+ ((d.eolien) ? d.eolien : 0)
				+ ((d.fioul) ? d.fioul : 0)
				+ ((d.gaz) ? d.gaz : 0)
				+ ((d.hydraulique) ? d.hydraulique : 0)
				+ ((d.nucleaire) ? d.nucleaire : 0)
				+ ((d.pompage) ? d.pompage : 0)
				+ ((d.solaire) ? d.solaire : 0)

				var nrj = 

				((d.eolien) ? d.eolien : 0)
				+ ((d.hydraulique) ? d.hydraulique : 0)
				+ ((d.pompage) ? d.pompage : 0)
				+ ((d.solaire) ? d.solaire : 0)

				return (nrj && conso) ? nrj * 100 / conso : null; 
			};
			
			var rteFossilePercentCallback = function(d){
				var conso = 
				((d.autres) ? d.autres : 0)
				+ ((d.charbon) ? d.charbon : 0)
				// + ((d.echCommAllemagne) ? d.echCommAllemagne : 0)
				// + ((d.echCommAngleterre) ? d.echCommAngleterre : 0)
				// + ((d.echCommBelgique) ? d.echCommBelgique : 0)
				// + ((d.echCommEspagne) ? d.echCommEspagne : 0)
				// + ((d.echCommItalie) ? d.echCommItalie : 0)
				// + ((d.echCommSuisse) ? d.echCommSuisse : 0)
				// + ((d.echPhysiques) ? d.echPhysiques : 0)
				+ ((d.eolien) ? d.eolien : 0)
				+ ((d.fioul) ? d.fioul : 0)
				+ ((d.gaz) ? d.gaz : 0)
				+ ((d.hydraulique) ? d.hydraulique : 0)
				+ ((d.nucleaire) ? d.nucleaire : 0)
				+ ((d.pompage) ? d.pompage : 0)
				+ ((d.solaire) ? d.solaire : 0)

				var nrj = 
				+ ((d.charbon) ? d.charbon : 0)
				+ ((d.fioul) ? d.fioul : 0)
				+ ((d.gaz) ? d.gaz : 0)
				// + ((d.nucleaire) ? d.nucleaire : 0)

				return (nrj && conso) ? nrj * 100 / conso : null; 
			};

			var rteTimeCallback = function(el){ return new Date(el.date); }
			var rte_parser = Calendar.data.create(rteTimeCallback);
			var possible_displays = {
				co2 : {
					name : "Co2 produit par kWh consomme (g)"
					, rte_closure : Calendar.data.retreiveValueCallbackClosure(
						rteCo2Callback
						, d3.mean
					)
					, rte_bounds_closure : Calendar.data.retreiveBoundsCallbackClosure(
						rteTimeCallback
						, rteCo2Callback
						, d3.mean
					)
				}
				, conso : {
					name : "Consommation (MWh)"
					, rte_closure : Calendar.data.retreiveValueCallbackClosure(
						rteConsommationCallback
						, d3.mean
					)
					, rte_bounds_closure : Calendar.data.retreiveBoundsCallbackClosure(
						rteTimeCallback
						, rteConsommationCallback
						, d3.mean
					)
				}
				, nucleaire : {
					name : "Pourcentage de nucleaire"
					, rte_closure : Calendar.data.retreiveValueCallbackClosure(
						rteNucleairePercentCallback
						, d3.mean
					)
					, rte_bounds_closure : Calendar.data.retreiveBoundsCallbackClosure(
						rteTimeCallback
						, rteNucleairePercentCallback
						, d3.mean
					)
				}
				, nrj_ren : {
					name : "Pourcentage de energie renouvelable"
					, rte_closure : Calendar.data.retreiveValueCallbackClosure(
						rteNRJRenPercentCallback
						, d3.mean
					)
					, rte_bounds_closure : Calendar.data.retreiveBoundsCallbackClosure(
						rteTimeCallback
						, rteNRJRenPercentCallback
						, d3.mean
					)
				}
				, fossile : {
					name : "Pourcentage de energie renouvelable"
					, rte_closure : Calendar.data.retreiveValueCallbackClosure(
						rteFossilePercentCallback
						, d3.mean
					)
					, rte_bounds_closure : Calendar.data.retreiveBoundsCallbackClosure(
						rteTimeCallback
						, rteFossilePercentCallback
						, d3.mean
					)
				}
			}
			
			// rte_data = rte_parser(rte_data);
			// console.log(rte_data)
			// var rte_datagrab_callback = function(){
			// 	var me = this;
			// 	var arguments_call = arguments;
			// 	if(me.renderer.bounds){
			// 		var bounds = me.renderer.bounds.apply(me, arguments);
			// 		// console.log(bounds);
			// 		var url = getRTEURl(bounds.start);
			// 		$.ajax({
			// 			url : url
			// 			, dataType : 'jsonp'
			// 			, success : function(json){
			// 				console.log(json)
			// 				var data = rte_parser(json.list);
			// 				console.log(data)
			// 				var args = [];
			// 				args.splice(0, 0, data);
			// 				for(var i=0; i< arguments_call.length;i++) args.push(arguments_call[i])
			// 				me.draw.apply(me, args);
			// 			}
			// 		});
			// 	}
			// 	else{
			// 		d3.json("mokup/rte.json", function(json){
						// var args = [];
			// 			var data =  rte_parser(json.mixenergies.list));
			// 			args.splice(0, 0, rte_data);
			// 			for(var i=0; i< arguments.length;i++) args.push(arguments[i])
			// 			this.draw.apply(this, args);
			// 		})
			// 	}
			// }
			var rte_datagrab_callback = function(){
				var arguments_call = arguments;
				var me = this;
				d3.json("mokup/rte.json", function(json){
					var args = [];
					var data =  rte_parser(json.mixenergies.list);
					console.log(data)
					args.splice(0, 0, data);
					for(var i=0; i< arguments_call.length;i++) args.push(arguments_call[i])
					me.draw.apply(me, args);
				})
			}
			

			


			/* ************************** */
			/* 
				DEFINE INITIAL VIEW
			*/
			var selectedColorScheme = 'RdYlGn';
			var selectedColorSchemeInverse = true;
			var selectedBuckets = 9;
			var selected_year = 2013
			var selected_week = 22
			var selected_month = 5
			var selected_display = "co2";
			var themes = ["day", "week", "month", "year"];
			var displays = ["co2", "conso", "nucleaire", "nrj_ren", "fossile"];
			var selected_theme = "year";
			var years = [2011, 2012, 2013];
			var weeks = [21,22,23];
			[]

			/* ************************** */
			/* 
				INJECT DATA INTO SELECTORS 
			*/
			createColorSelector(
				colorbrewer
				, selectedColorScheme
				, selectedColorSchemeInverse
			);
			createYearSelector(years, selected_year);
			createWeekSelector(weeks, selected_week);
			createMonthSelector(selected_month);
			createDaySelector();
			createThemeSelector(themes, selected_theme);
			createDisplaySelector(displays, selected_display);

			console.log(possible_displays[selected_display])
			/* ************************** */
			/* 
				CALENDAR INITIALIZATION 
			*/
			var calendar = new Calendar( {
				name: "Co2 produit par kWh consommé (g)"
				, renderer : new Calendar.renderer.year()
				, buckets : selectedBuckets
				, colorScheme : selectedColorScheme
				, colorSchemeInverse : selectedColorSchemeInverse
				, retreiveDataCallback : rte_datagrab_callback
				, retreiveCalcsCallback : possible_displays[selected_display].rte_bounds_closure
				, retreiveValueCallback : possible_displays[selected_display].rte_closure
				, width : $("#container").width()
				, height: 800		
			});

			

			function refresh(switch_renderer){
				var years = $.map( $('#years option:selected'),
                  			function(e) { return parseInt($(e).val()) } );

				var months = $.map( $('#months option:selected'),
                  			function(e) { return parseInt($(e).val()); } );
				switch($("#themes").attr("value")){
					case 'day':
						if(switch_renderer)
							calendar.renderer = new Calendar.renderer.day();
						calendar.createTiles(
							d3.max(years)
							, $("#weeks").attr("value")
							, $("#days").attr("value")
						);
						break;
					case 'week':
						if(switch_renderer)
							calendar.renderer = new Calendar.renderer.week();
						calendar.createTiles(
							d3.max(years)
							, $("#weeks").attr("value")
						);
						break;
					case 'month':
						if(switch_renderer)
							calendar.renderer = new Calendar.renderer.month();
						calendar.createTiles(
							d3.max(years)
							, months
						);
						break;
					case 'year':
						if(switch_renderer)
							calendar.renderer = new Calendar.renderer.year();
						calendar.createTiles(
							years
						);
						break;
					default:
						break;
				}
			}

			refresh();

			$("#themes").change(function(e){
				refresh(true);
			});

			$("#color, #color_inversed").change(function(e){
				calendar.colorScheme = $("#color").attr("value");
				calendar.colorSchemeInverse = ($("#color_inversed").attr("value") == "inversed")? true : false;
				calendar.createLegend();
				refresh();
			});

			$("#weeks, #years, #months, #days").change(function(e){
				refresh();
			});

			$("#displays").change(function(e){
				var selected_display = $("#displays").attr("value");
				console.log(selected_display)
				calendar.name = possible_displays[selected_display].name; 
				calendar.retreiveCalcsCallback = possible_displays[selected_display].rte_bounds_closure
				calendar.retreiveValueCallback = possible_displays[selected_display].rte_closure
				refresh();
			});
		
		
		}
	</script>
	<div id="container">
		<div id="header">
			<div id="period">
					<h1 id="title"></h1>
					<br>
					<h2>P&eacute;riode &eacute;tudi&eacute;e: <p class="start"></p> - </p><p class="end"></p></h2>
				</div>		
			<div id="legend">
				<div>
					<ul>
					</ul>
					<p class="more"></p>
					<p class="less"></p>
				</div>
			</div>
		</div>
		<div id="selectors" >
			<select id="displays" class="input-medium" style="display: none"></select>
			<select id="themes" class="input-medium" style="display: none"></select>
			<select id="years" multiple class="input-small" style="display: none"></select>
			<select id="months" multiple class="input-small" style="display: none"></select>
			<select id="weeks" class="input-medium" style="display: none"></select>
			<select id="days" class="input-medium" style="display: none"></select>
			<select id="color" class="input-small" style="display: none"></select>
			<select id="color_inversed" class="input-small" style="display: none"></select>
		</div>
		
		<div id="vis"></div>
		
		
	</div>
</body>
</html>