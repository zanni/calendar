<html>
<head>
	<title>Calendar.js</title>
	<link rel="stylesheet" href="../g2/css_new/reset.css"></link>
	<link rel="stylesheet" href="../g2/css_new/colorbrewer.css"></link>
	<link rel="stylesheet" href="../g2/css_new/calendar.css"></link>
</head>
<body>
	<script type="text/javascript" src="../g2/js/jquery/jquery-1.8.3.min.js"></script>
	<script type="text/javascript" src="../g2/js/d3/d3.min.js"></script>
	<script type="text/javascript" src="../g2/js/d3/d3.layout.min.js"></script>
	<script type="text/javascript" src="../g2/js/colorbrewer/colorbrewer.js"></script>
	<script type="text/javascript" src="../g2/js/calendar/calendar.js"></script>
	<script type="text/javascript" src="../g2/js/calendar/i18n/calendar.fr.js"></script>
	<script type="text/javascript" src="../g2/js/calendar/calendar.parser.js"></script>
	<script type="text/javascript" src="../g2/js/utils/utils.js"></script>
	<script type="text/javascript" src="../g2/js/browserdetect/browserdetect.js"></script>
		<script>
		/* ************************** */
		/* 
			fill weeks select with week data
		*/
		function createYearSelector(data, selected){
			var years = d3.select("#years");

			var select = years.selectAll("option")
				.data(d3.keys(data));

			select.enter().append("option")
				.text(function(d){
					return d;
				})
				.attr("id", function(d){ return "years_"+d})
				.attr("value", function(d){ return d});
			select.exit().remove();
			
			// $("#years").css("display", "inline");
			
			years.select("#years_"+selected).attr("selected", true);	
		}
		/* ************************** */
		/* 
			fill weeks select with week data
		*/
		function createWeekSelector(data, selected){
			var weeks = d3.select("#weeks");
			
			var select = weeks.selectAll("option")
				.data(d3.keys(data[$("#years").attr("value")]));
			
			

			select.enter().append("option")
				.text(function(d){
					return "Semaine " + d;
				})
				.attr("id", function(d){ return "weeks_"+d})
				.attr("value", function(d){ return d});
			select.exit().remove();
			
			$("#weeks").css("display", "inline");
			
			weeks.select("#weeks_"+selected).attr("selected", true);	
		}
		/* ************************** */
		/* 
			retreive value generic callback closure
		*/
		var retreiveValueCallbackClosure = function(data, specializedFunc, aggregatFunc, filterFunc){

			return function(y, w, d, h){
				try{	
					var logs = [];

					for(var i in data[y][w][d][h]){

						var raw = data[y][w][d][h][i];
						console.log(new Date(raw.date));
						if(!filterFunc || filterFunc(raw)){

							logs.push(specializedFunc(raw));

						}
							

					}
					var val = aggregatFunc(logs);;
					return val;
				}
				catch(err){
					return null;
				}
				
			}

		}
		/* ************************** */
		/* 
			retreive bounds generic callback closure
		*/
		var retreiveBoundsCallbackClosure = function(data, specializedTimeFunc, specializedFunc, aggregatFunc, filterFunc){

			return function(selected_year, selected_week){
				// if(G2_Utils.array.exists(data, selected_year, selected_week)){	
					var logs = []	
						, first = true
						, start;

					for(var y in data){

						for(var w in data[y]){

							for(var d in data[y][w]){

								for(var h in data[y][w][d]){

									var temp = [];

									for(var i in data[y][w][d][h]){

										var raw = data[y][w][d][h][i];

										

										if(!filterFunc || filterFunc(raw)){

											temp.push(specializedFunc(raw));

											if(first
												&& y == selected_year 
												&& w == selected_week){

												start = d3.time.monday(specializedTimeFunc(raw));

												first = false;

											}

										}

										logs.push(aggregatFunc(temp));
											

									}

								}

							}

						}

					// }

					return {
						'min': d3.round(d3.min(logs), 2)
						, 'max': d3.round(d3.max(logs), 2)
						, 'mean': d3.round(d3.mean(logs), 2)
						, 'median': d3.round(d3.median(logs), 2)
						, 'start' : start
						, 'end' : new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000)
					};

				}
				
				return null;
			}

		}

		$.ready = function(){


			d3.json('../g2/mokup/rte.json', function(json) {

				/* 
					RTE DATA MAPPING
				*/
				var rte_data = json.mixenergies.list;
				var rteCo2Callback = function(d){ return d.tauxDeCo2; };
				var rteTimeCallback = function(el){ return new Date(el.date); }
				var rte_parser = Calendar.parser.create(rteTimeCallback);
				rte_data = rte_parser(rte_data);
				var rte_closure = retreiveValueCallbackClosure(
					rte_data
					, rteCo2Callback
					, d3.mean
				);

				var rte_bounds_closure = retreiveBoundsCallbackClosure(
					rte_data
					, rteTimeCallback
					, rteCo2Callback
					, d3.mean
				);

				/* ************************** */
				/* 
					DEFINE INITIAL VIEW
				*/
				var selected_year = d3.max(d3.keys(rte_data));
				var selected_week = d3.max(d3.keys(rte_data[selected_year]));	
				
				/* ************************** */
				/* 
					INJECT DATA INTO SELECTORS 
				*/
				createYearSelector(rte_data, selected_year);
				createWeekSelector(rte_data, selected_week);


				

				var calendar = Calendar.init( {
					name: "Co2 produit par kWh consomm√© (g)"
					, buckets : 9
					, colorScheme : 'RdYlGn'
					, colorSchemeInverse : true
					, retreiveCalcsCallback : rte_bounds_closure
					, retreiveValueCallback : rte_closure
						
				});

				calendar.reColorTiles(selected_year, selected_week);

				$("#weeks, #infras, #year, #color, #color_inversed").change(function(e){
					
					calendar.reColorTiles(
						$("#years").attr("value")
						, $("#weeks").attr("value")
					);
				});
		
			});
		}
	</script>
	<div id="container">
		<div id="period">
				<h1>CO2 Produit par kWh consomm&eacute;</h1>
				<br>
				<h2>P&eacute;riode &eacute;tudi&eacute;e: <p class="start"></p> - </p><p class="end"></p></h2>
			</div>		
		<div id="legend">
			<div>
				<ul>
				</ul>
				<p class="more"></p>
				<p class="less"></p>
			</div>
			
		</div>

		<div id="vis"></div>
		<select id="years" class="input-small" style="display: none"></select>
		<select id="weeks" class="input-medium" style="display: none"></select>
		
	</div>
</body>
</html>